<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ªØ li·ªáu t·ª´ c·∫£m bi·∫øn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .chart-container { position: relative; height: 250px; width: 100%; margin-bottom: 30px; }
        .chart-title { text-align: center; margin-bottom: 20px; font-size: 24px; font-weight: bold; }
        .control-section { margin-top: 30px; text-align: center; }
        .control-title { font-size: 22px; font-weight: bold; margin-bottom: 20px; }
        .btn-control { margin: 0 5px; min-width: 120px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="chart-title">D·ªØ li·ªáu t·ª´ c·∫£m bi·∫øn v√† kho·∫£ng c√°ch</h1>

        <div class="row">
            <div class="col-md-4">
                <div class="chart-container"><canvas id="temperatureChart"></canvas></div>
            </div>
            <div class="col-md-4">
                <div class="chart-container"><canvas id="humidityChart"></canvas></div>
            </div>
            <div class="col-md-4">
                <div class="chart-container"><canvas id="distanceChart"></canvas></div>
            </div>
        </div>

        <div class="control-section">
            <h2 class="control-title">ƒêi·ªÅu khi·ªÉn Relay</h2>
            <button class="btn btn-primary btn-control" onclick="publishMessage('relay/1', 'ON')">B·∫≠t Relay 1</button>
            <button class="btn btn-danger btn-control" onclick="publishMessage('relay/1', 'OFF')">T·∫Øt Relay 1</button>
            <button class="btn btn-primary btn-control" onclick="publishMessage('relay/2', 'ON')">B·∫≠t Relay 2</button>
            <button class="btn btn-danger btn-control" onclick="publishMessage('relay/2', 'OFF')">T·∫Øt Relay 2</button>
        </div>
    </div>

    <script>
        const mqttBroker = "wss://eb1e9eaf87e74023b537fbaf7fc8138a.s1.eu.hivemq.cloud:8884/mqtt";
        const mqttOptions = {
            username: "tuanlc",
            password: "123456aA@",
            reconnectPeriod: 5000
        };
        const client = mqtt.connect(mqttBroker, mqttOptions);

        client.on("connect", function () {
            console.log("‚úÖ K·∫øt n·ªëi MQTT th√†nh c√¥ng!");
            client.subscribe("sensor/temperature");
            client.subscribe("sensor/humidity");
            client.subscribe("sensor/distance");
        });

        client.on("error", function (error) {
            console.error("L·ªói k·∫øt n·ªëi MQTT:", error);
        });

        let sensorData = {
            temperature: [],
            humidity: [],
            distance: []
        };

        function createChart(ctx, label, bgColor, borderColor) {
            return new Chart(ctx, {
                type: "line",
                data: {
                    labels: [],
                    datasets: [{
                        label: label,
                        backgroundColor: bgColor,
                        borderColor: borderColor,
                        data: [],
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        const temperatureChart = createChart(
            document.getElementById("temperatureChart").getContext("2d"),
            "Nhi·ªát ƒë·ªô (¬∞C)", "rgba(255, 99, 132, 0.2)", "rgba(255, 99, 132, 1)"
        );
        const humidityChart = createChart(
            document.getElementById("humidityChart").getContext("2d"),
            "ƒê·ªô ·∫©m (%)", "rgba(54, 162, 235, 0.2)", "rgba(54, 162, 235, 1)"
        );
        const distanceChart = createChart(
            document.getElementById("distanceChart").getContext("2d"),
            "Kho·∫£ng c√°ch (cm)", "rgba(75, 192, 192, 0.2)", "rgba(75, 192, 192, 1)"
        );

        function updateChart(chart, datasetKey, value) {
            if (!chart) return;
            
            const now = new Date();
            const timestamp = now.toLocaleTimeString();

            sensorData[datasetKey].push({ time: now, value });

            sensorData[datasetKey] = sensorData[datasetKey].filter(entry => {
                return entry.time.toDateString() === now.toDateString();
            });

            chart.data.labels = sensorData[datasetKey].map(entry => entry.time.toLocaleTimeString());
            chart.data.datasets[0].data = sensorData[datasetKey].map(entry => entry.value);
            chart.update();
        }

        client.on("message", function (topic, message) {
            const value = parseFloat(message.toString());
            console.log(`üì• Nh·∫≠n d·ªØ li·ªáu t·ª´ ${topic}:`, value);

            if (!isNaN(value)) {
                if (topic === "sensor/temperature") updateChart(temperatureChart, "temperature", value);
                else if (topic === "sensor/humidity") updateChart(humidityChart, "humidity", value);
                else if (topic === "sensor/distance") updateChart(distanceChart, "distance", value);
            } else {
                console.error(`D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá t·ª´ ${topic}:`, message.toString());
            }
        });

        function publishMessage(topic, message) {
            if (client.connected) {
                client.publish(topic, message);
                console.log(`üöÄ G·ª≠i l·ªánh [${message}] ƒë·∫øn ${topic}`);
            } else {
                console.error("Kh√¥ng th·ªÉ g·ª≠i l·ªánh, MQTT ch∆∞a k·∫øt n·ªëi!");
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
